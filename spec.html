<!DOCTYPE html>
<meta charset="utf-8">
<pre class="metadata">
title: x/freeSpacing flag for regular expressions
status: proposal
location: https://motiz88.github.io/proposal-regexp-freespacing-flag/
copyright: false
contributors: Moti Zilberman
</pre>
<script src="ecmarkup.js" defer></script>
<link rel="stylesheet" href="ecmarkup.css">
<style>
  hr {
    height: 0.25em;
    background: #ccc;
    border: 0;
    margin: 2em 0;
  }
</style>

<p>The algorithm listed in <a href="https://tc39.github.io/ecma262/#sec-regexpinitialize" title="Runtime Semantics: RegExpInitialize ( obj, pattern, flags )">21.2.3.2.2</a> is modified as follows.</p>

<emu-clause id="sec-regexpinitialize" aoid="RegExpInitialize">
<h1>Runtime Semantics: RegExpInitialize ( _obj_, _pattern_, _flags_ )</h1>
<p>When the abstract operation RegExpInitialize with arguments _obj_, _pattern_, and _flags_ is called, the following steps are taken:</p>
<emu-alg>
    1. If _pattern_ is *undefined*, let _P_ be the empty String.
    1. Else, let _P_ be ? ToString(_pattern_).
    1. If _flags_ is *undefined*, let _F_ be the empty String.
    1. Else, let _F_ be ? ToString(_flags_).
    1. If _F_ contains any code unit other than `"g"`, `"i"`, `"m"`, `"s"`, `"u"`, <ins>`"x"`</ins> or `"y"` or if it contains the same code unit more than once, throw a *SyntaxError* exception.
    1. If _F_ contains `"u"`, let _BMP_ be *false*; else let _BMP_ be *true*.
    1. If _BMP_ is *true*, then
      1. Parse _P_ using the grammars in <emu-xref href="#sec-patterns"></emu-xref> and interpreting each of its 16-bit elements as a Unicode BMP code point. UTF-16 decoding is not applied to the elements. The goal symbol for the parse is |Pattern[~U, ~N]|. If the result of parsing contains a |GroupName|, reparse with the goal symbol |Pattern[~U, +N]| and use this result instead. Throw a *SyntaxError* exception if _P_ did not conform to the grammar, if any elements of _P_ were not matched by the parse, or if any Early Error conditions exist.
      1. Let _patternCharacters_ be a List whose elements are the code unit elements of _P_.
    1. Else,
      1. Parse _P_ using the grammars in <emu-xref href="#sec-patterns"></emu-xref> and interpreting _P_ as UTF-16 encoded Unicode code points (<emu-xref href="#sec-ecmascript-language-types-string-type"></emu-xref>). The goal symbol for the parse is |Pattern[+U, +N]|. Throw a *SyntaxError* exception if _P_ did not conform to the grammar, if any elements of _P_ were not matched by the parse, or if any Early Error conditions exist.
      1. Let _patternCharacters_ be a List whose elements are the code points resulting from applying UTF-16 decoding to _P_'s sequence of elements.
    1. Set _obj_.[[OriginalSource]] to _P_.
    1. Set _obj_.[[OriginalFlags]] to _F_.
    1. Set _obj_.[[RegExpMatcher]] to the internal procedure that evaluates the above parse of _P_ by applying the semantics provided in <emu-xref href="#sec-pattern-semantics"></emu-xref> using _patternCharacters_ as the pattern's List of |SourceCharacter| values and _F_ as the flag parameters.
    1. Perform ? Set(_obj_, `"lastIndex"`, 0, *true*).
    1. Return _obj_.
</emu-alg>
<emu-note type="editor">It is possible to specify a preprocessing step for _P_ that removes whitespace and line comments if _F_ contains `"x"`, but it is better to extend the grammars in <emu-xref href="#sec-patterns"></emu-xref> appropriately. This remains to be done.</emu-note>
</emu-clause>
<hr>

<p>The section <a href="https://tc39.github.io/ecma262/#sec-notation">21.2.2.1 Notation</a> is modified as follows.</p>
<emu-clause id="sec-notation">
  <h1>Notation</h1>
  <p>The descriptions below use the following variables:</p>
  <ul>
    <li>
      _Input_ is a List consisting of all of the characters, in order, of the String being matched by the regular expression pattern. Each character is either a code unit or a code point, depending upon the kind of pattern involved. The notation _Input_[_n_] means the _n_<sup>th</sup> character of _Input_, where _n_ can range between 0 (inclusive) and _InputLength_ (exclusive).
    </li>
    <li>
      _InputLength_ is the number of characters in _Input_.
    </li>
    <li>
      _NcapturingParens_ is the total number of left-capturing parentheses (i.e. the total number of <emu-grammar>Atom :: `(` GroupSpecifier Disjunction `)`</emu-grammar> Parse Nodes) in the pattern. A left-capturing parenthesis is any `(` pattern character that is matched by the `(` terminal of the <emu-grammar>Atom :: `(` GroupSpecifier Disjunction `)`</emu-grammar> production.
    </li>
    <li>
      _DotAll_ is *true* if the RegExp object's [[OriginalFlags]] internal slot contains `"s"` and otherwise is *false*.
    </li>
    <li>
      <ins>_FreeSpacing_ is *true* if the RegExp object's [[OriginalFlags]] internal slot contains `"x"` and otherwise is *false*.</ins>
    </li>
    <li>
      _IgnoreCase_ is *true* if the RegExp object's [[OriginalFlags]] internal slot contains `"i"` and otherwise is *false*.
    </li>
    <li>
      _Multiline_ is *true* if the RegExp object's [[OriginalFlags]] internal slot contains `"m"` and otherwise is *false*.
    </li>
    <li>
      _Unicode_ is *true* if the RegExp object's [[OriginalFlags]] internal slot contains `"u"` and otherwise is *false*.
    </li>
  </ul>
  <emu-note type="editor">The _FreeSpacing_ variable has been added the sake of convenience; it will be removed from the proposal if it ultimately remains unused.</emu-note>
</emu-clause>
<hr>

<p>The algorithm listed in <a href="https://tc39.github.io/ecma262/#sec-get-regexp.prototype.flags" title="get RegExp.prototype.flags">21.2.5.4</a> is modified as follows.</p>

<emu-clause id="sec-get-regexp.prototype.flags">
  <h1>get RegExp.prototype.flags</h1>
  <p>`RegExp.prototype.flags` is an accessor property whose set accessor function is *undefined*. Its get accessor function performs the following steps:</p>
  <emu-alg>
    1. Let _R_ be the *this* value.
    1. If Type(_R_) is not Object, throw a *TypeError* exception.
    1. Let _result_ be the empty String.
    1. Let _global_ be ToBoolean(? Get(_R_, `"global"`)).
    1. If _global_ is *true*, append the code unit 0x0067 (LATIN SMALL LETTER G) as the last code unit of _result_.
    1. Let _ignoreCase_ be ToBoolean(? Get(_R_, `"ignoreCase"`)).
    1. If _ignoreCase_ is *true*, append the code unit 0x0069 (LATIN SMALL LETTER I) as the last code unit of _result_.
    1. Let _multiline_ be ToBoolean(? Get(_R_, `"multiline"`)).
    1. If _multiline_ is *true*, append the code unit 0x006D (LATIN SMALL LETTER M) as the last code unit of _result_.
    1. Let _dotAll_ be ToBoolean(? Get(_R_, `"dotAll"`)).
    1. If _dotAll_ is *true*, append the code unit 0x0073 (LATIN SMALL LETTER S) as the last code unit of _result_.
    1. Let _unicode_ be ToBoolean(? Get(_R_, `"unicode"`)).
    1. If _unicode_ is *true*, append the code unit 0x0075 (LATIN SMALL LETTER U) as the last code unit of _result_.
    1. <ins>Let _freeSpacing_ be ToBoolean(? Get(_R_, `"freeSpacing"`)).</ins>
    1. <ins>If _freeSpacing_ is *true*, append the code unit 0x0078 (LATIN SMALL LETTER X) as the last code unit of _result_.</ins>
    1. Let _sticky_ be ToBoolean(? Get(_R_, `"sticky"`)).
    1. If _sticky_ is *true*, append the code unit 0x0079 (LATIN SMALL LETTER Y) as the last code unit of _result_.
    1. Return _result_.
  </emu-alg>
</emu-clause>
<hr>

<p>The following new section is added before <a href="https://tc39.github.io/ecma262/#sec-get-regexp.prototype.global">21.2.5.5 get RegExp.prototype.global</a>.</p>

<emu-clause id="sec-get-regexp.prototype.freeSpacing">
  <h1>get RegExp.prototype.freeSpacing</h1>
  <p>`RegExp.prototype.freeSpacing` is an accessor property whose set accessor function is *undefined*. Its get accessor function performs the following steps:</p>
  <emu-alg>
    1. Let _R_ be the *this* value.
    1. If Type(_R_) is not Object, throw a *TypeError* exception.
    1. If _R_ does not have an [[OriginalFlags]] internal slot, then
      1. If SameValue(_R_, %RegExpPrototype%) is *true*, return *undefined*.
      1. Otherwise, throw a *TypeError* exception.
    1. Let _flags_ be _R_.[[OriginalFlags]].
    1. If _flags_ contains the code unit 0x0078 (LATIN SMALL LETTER X), return *true*.
    1. Return *false*.
  </emu-alg>
</emu-clause>
